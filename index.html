<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>云剪贴板</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --bg: #f4f7fb;
        --card: #ffffff;
        --text: #162031;
        --muted: #64748b;
        --primary: #1267d6;
        --border: #dbe4ef;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: radial-gradient(circle at top right, #e2ecff, var(--bg) 52%);
        color: var(--text);
      }
      .container {
        max-width: 960px;
        margin: 40px auto;
        padding: 0 16px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 18px;
        box-shadow: 0 10px 30px rgba(18, 103, 214, 0.08);
      }
      h1, h2 { margin-top: 0; }
      .muted { color: var(--muted); }
      .row { display: flex; gap: 12px; flex-wrap: wrap; }
      .half { flex: 1 1 320px; }
      input, textarea, select, button {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
      }
      textarea {
        min-height: 170px;
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      }
      button {
        cursor: pointer;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
      }
      .ghost {
        background: #fff;
        color: var(--primary);
        border: 1px solid var(--primary);
      }
      .code-box {
        background: #0f172a;
        color: #e2e8f0;
        padding: 12px;
        border-radius: 10px;
        overflow-x: auto;
      }
      .render {
        padding: 16px;
        border: 1px dashed var(--border);
        border-radius: 10px;
        min-height: 100px;
      }
      .preview-title {
        margin-top: 12px;
        margin-bottom: 8px;
        font-size: 13px;
        color: var(--muted);
      }
      .list-item {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        margin: 8px 0;
      }
      .inline-btn {
        width: auto;
        padding: 6px 10px;
        font-size: 12px;
        margin-right: 8px;
      }
      .danger {
        background: #dc2626;
      }
      .warn {
        color: #b45309;
      }
      @media (max-width: 700px) {
        .container { margin-top: 20px; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>云剪贴板</h1>
        <p class="muted">默认不开放列表，不可检索。输入唯一长编码串可访问；登录后可查看自己的全部剪贴板。</p>
      </div>

      <div class="card">
        <h2>用户登录</h2>
        <div class="row">
          <div class="half">
            <input id="email" type="email" placeholder="邮箱" />
          </div>
          <div class="half">
            <input id="password" type="password" placeholder="密码" />
          </div>
        </div>
        <div class="row" style="margin-top: 12px;">
          <div class="half"><button id="signupBtn" class="ghost">注册</button></div>
          <div class="half"><button id="loginBtn">登录</button></div>
          <div class="half"><button id="logoutBtn" class="ghost">退出</button></div>
        </div>
        <p id="authMsg" class="muted"></p>
        <p id="authUser" class="muted"></p>
      </div>

      <div class="card" id="myWrap" style="display: none;">
        <h2>我的云剪贴板</h2>
        <div class="row" style="margin-top: 12px;">
          <div class="half"><button id="refreshMineBtn" class="ghost">刷新列表</button></div>
        </div>
        <p id="mineMsg" class="muted"></p>
        <div id="mineList"></div>
      </div>

      <div class="card">
        <h2>发布剪贴板</h2>
        <div class="row">
          <div class="half">
            <label for="format">内容类型</label>
            <select id="format">
              <option value="markdown">Markdown</option>
              <option value="latex">LaTeX</option>
            </select>
          </div>
        </div>
        <label for="content">内容</label>
        <textarea id="content" placeholder="输入 Markdown 或 LaTeX"></textarea>
        <div class="preview-title">编辑预览（支持 Markdown + LaTeX 混排）</div>
        <div id="editorPreview" class="render"></div>
        <p id="editState" class="warn"></p>
        <div class="row" style="margin-top:12px;">
          <div class="half"><button id="publishBtn">发布并生成编码</button></div>
          <div class="half"><button id="cancelEditBtn" class="ghost" style="display:none;">取消编辑</button></div>
          <div class="half"><button id="previewBtn" class="ghost">刷新预览</button></div>
        </div>
        <p id="publishMsg" class="muted"></p>
        <div id="codeWrap" style="display:none;">
          <p>请保存这个编码串（丢失后无法找回）：</p>
          <div class="code-box" id="codeBox"></div>
          <div class="row" style="margin-top:12px;">
            <div class="half"><button id="copyPreviewLinkBtn" class="ghost">复制预览链接</button></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>通过编码访问</h2>
        <label for="codeInput">唯一编码串</label>
        <input id="codeInput" placeholder="例如 acutyejf2gfyu..." />
        <div class="row" style="margin-top:12px;">
          <div class="half"><button id="openBtn">打开</button></div>
        </div>
        <p id="openMsg" class="muted"></p>
        <div id="meta" class="muted"></div>
        <div id="render" class="render"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" defer crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" defer crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
      let supabaseClient = null;
      let accessToken = '';
      let editingCode = '';
      let mineLoadSeq = 0;

      const authMsg = document.getElementById('authMsg');
      const authUser = document.getElementById('authUser');
      const myWrap = document.getElementById('myWrap');
      const mineMsg = document.getElementById('mineMsg');
      const mineList = document.getElementById('mineList');

      const publishBtn = document.getElementById('publishBtn');
      const previewBtn = document.getElementById('previewBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const copyPreviewLinkBtn = document.getElementById('copyPreviewLinkBtn');
      const editState = document.getElementById('editState');
      const publishMsg = document.getElementById('publishMsg');
      const codeWrap = document.getElementById('codeWrap');
      const codeBox = document.getElementById('codeBox');
      const editorPreview = document.getElementById('editorPreview');

      const openBtn = document.getElementById('openBtn');
      const openMsg = document.getElementById('openMsg');
      const meta = document.getElementById('meta');
      const render = document.getElementById('render');

      function renderMath(container) {
        if (!window.renderMathInElement) {
          setTimeout(() => {
            if (window.renderMathInElement) {
              renderMath(container);
            }
          }, 120);
          return;
        }
        window.renderMathInElement(container, {
          throwOnError: false,
          delimiters: [
            { left: '$$', right: '$$', display: true },
            { left: '$', right: '$', display: false },
            { left: '\\(', right: '\\)', display: false },
            { left: '\\[', right: '\\]', display: true }
          ]
        });
      }

      function renderMixedContent(container, content, format) {
        if (format === 'latex') {
          container.innerHTML = '';
          try {
            katex.render(content, container, { throwOnError: false, displayMode: true });
          } catch (e) {
            container.textContent = content;
          }
          return;
        }

        container.innerHTML = marked.parse(content, { breaks: true, gfm: true });
        renderMath(container);
      }

      function renderContent(content, format) {
        renderMixedContent(render, content, format);
      }

      function refreshEditorPreview() {
        const content = document.getElementById('content').value.trim();
        const format = document.getElementById('format').value;
        if (!content) {
          editorPreview.innerHTML = '<span class="muted">预览区：输入内容后会显示渲染结果</span>';
          return;
        }
        renderMixedContent(editorPreview, content, format);
      }

      function previewUrlByCode(code) {
        return `${window.location.origin}${window.location.pathname}?code=${encodeURIComponent(code)}`;
      }

      function authHeaders() {
        return accessToken ? { Authorization: `Bearer ${accessToken}` } : {};
      }

      async function apiFetchJson(url, options) {
        const res = await fetch(url, options);
        const raw = await res.text();
        let data = null;
        try {
          data = raw ? JSON.parse(raw) : {};
        } catch (_err) {
          data = { error: `接口返回非 JSON（HTTP ${res.status}）: ${url}`, raw };
        }
        if (!res.ok) {
          throw new Error(data.error || `请求失败（HTTP ${res.status}）: ${url}`);
        }
        return data;
      }

      async function apiFetchJsonWithFallback(urls, options) {
        let lastError = null;
        for (const url of urls) {
          try {
            return await apiFetchJson(url, options);
          } catch (err) {
            lastError = err;
          }
        }
        throw lastError || new Error('请求失败');
      }

      function setCreateMode() {
        editingCode = '';
        editState.textContent = '';
        cancelEditBtn.style.display = 'none';
        publishBtn.textContent = '发布并生成编码';
      }

      function setEditMode(code) {
        editingCode = code;
        editState.textContent = `当前编辑: ${code}`;
        cancelEditBtn.style.display = 'block';
        publishBtn.textContent = '保存修改';
      }

      async function startEdit(code) {
        try {
          const data = await apiFetchJson(`/api/get?code=${encodeURIComponent(code)}`);

          document.getElementById('format').value = data.format;
          document.getElementById('content').value = data.content;
          refreshEditorPreview();
          setEditMode(code);
          publishMsg.textContent = '';
          codeWrap.style.display = 'none';
        } catch (err) {
          mineMsg.textContent = err.message;
        }
      }

      async function deleteMine(code) {
        const ok = window.confirm(`确认删除 ${code} 吗？删除后不可恢复。`);
        if (!ok) return;

        mineMsg.textContent = '删除中...';
        try {
          await apiFetchJsonWithFallback(
            [
              `/api/delete?code=${encodeURIComponent(code)}`,
              `/.netlify/functions/delete-clipboard?code=${encodeURIComponent(code)}`
            ],
            {
              method: 'DELETE',
              headers: authHeaders()
            }
          );

          if (editingCode === code) {
            setCreateMode();
            document.getElementById('content').value = '';
          }

          mineMsg.textContent = '删除成功';
          loadMyClipboards();
        } catch (err) {
          mineMsg.textContent = err.message;
        }
      }

      async function loadMyClipboards() {
        const seq = ++mineLoadSeq;
        if (!accessToken) {
          myWrap.style.display = 'none';
          return;
        }

        myWrap.style.display = 'block';
        mineMsg.textContent = '加载中...';
        mineList.innerHTML = '';

        try {
          const data = await apiFetchJson('/api/my', { headers: authHeaders() });
          if (seq !== mineLoadSeq) return;

          if (!data.items.length) {
            mineMsg.textContent = '你还没有发布过云剪贴板';
            return;
          }

          mineMsg.textContent = `共 ${data.items.length} 条`;
          data.items.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
              <div><strong>${item.code}</strong></div>
              <div class="muted">格式: ${item.format} | 创建时间: ${new Date(item.created_at).toLocaleString()}</div>
            `;

            const openBtnItem = document.createElement('button');
            openBtnItem.className = 'inline-btn';
            openBtnItem.textContent = '打开';
            openBtnItem.addEventListener('click', () => {
              document.getElementById('codeInput').value = item.code;
              openBtn.click();
            });

            const editBtn = document.createElement('button');
            editBtn.className = 'inline-btn ghost';
            editBtn.textContent = '编辑';
            editBtn.addEventListener('click', () => startEdit(item.code));

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'inline-btn danger';
            deleteBtn.textContent = '删除';
            deleteBtn.addEventListener('click', () => deleteMine(item.code));

            div.appendChild(openBtnItem);
            div.appendChild(editBtn);
            div.appendChild(deleteBtn);
            mineList.appendChild(div);
          });
        } catch (err) {
          if (seq !== mineLoadSeq) return;
          mineMsg.textContent = err.message;
        }
      }

      function setSession(session) {
        accessToken = session?.access_token || '';
        if (session?.user) {
          authUser.textContent = `已登录: ${session.user.email || session.user.id}`;
          loadMyClipboards();
        } else {
          authUser.textContent = '未登录';
          setCreateMode();
          mineMsg.textContent = '';
          mineList.innerHTML = '';
          myWrap.style.display = 'none';
        }
      }

      async function initAuth() {
        try {
          const conf = await apiFetchJson('/api/config');

          supabaseClient = window.supabase.createClient(conf.supabaseUrl, conf.supabasePublishableKey);

          const { data } = await supabaseClient.auth.getSession();
          setSession(data.session);

          supabaseClient.auth.onAuthStateChange((_event, session) => {
            setSession(session);
          });
        } catch (err) {
          authMsg.textContent = err.message;
        }
      }

      document.getElementById('signupBtn').addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) {
          authMsg.textContent = '请输入邮箱和密码';
          return;
        }

        authMsg.textContent = '注册中...';
        const { data, error } = await supabaseClient.auth.signUp({ email, password });
        if (error) {
          authMsg.textContent = error.message;
          return;
        }

        authMsg.textContent = data.session
          ? '注册并登录成功'
          : '注册成功，请根据邮件完成确认后再登录';
      });

      document.getElementById('loginBtn').addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) {
          authMsg.textContent = '请输入邮箱和密码';
          return;
        }

        authMsg.textContent = '登录中...';
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        authMsg.textContent = error ? error.message : '登录成功';
      });

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (!supabaseClient) return;
        await supabaseClient.auth.signOut();
        authMsg.textContent = '已退出';
      });

      document.getElementById('refreshMineBtn').addEventListener('click', loadMyClipboards);
      previewBtn.addEventListener('click', refreshEditorPreview);
      cancelEditBtn.addEventListener('click', () => {
        setCreateMode();
        publishMsg.textContent = '';
        refreshEditorPreview();
      });
      copyPreviewLinkBtn.addEventListener('click', async () => {
        const code = codeBox.textContent.trim();
        if (!code) return;
        const url = previewUrlByCode(code);
        try {
          await navigator.clipboard.writeText(url);
          publishMsg.textContent = '预览链接已复制';
        } catch (_err) {
          publishMsg.textContent = `预览链接: ${url}`;
        }
      });
      document.getElementById('content').addEventListener('input', refreshEditorPreview);
      document.getElementById('format').addEventListener('change', refreshEditorPreview);

      publishBtn.addEventListener('click', async () => {
        const content = document.getElementById('content').value.trim();
        const format = document.getElementById('format').value;

        if (!content) {
          publishMsg.textContent = '内容不能为空';
          return;
        }

        publishMsg.textContent = '发布中...';
        codeWrap.style.display = 'none';

        try {
          if (editingCode) {
            const data = await apiFetchJsonWithFallback(
              ['/api/update', '/.netlify/functions/update-clipboard'],
              {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                body: JSON.stringify({ code: editingCode, content, format })
              }
            );

            codeWrap.style.display = 'none';
            publishMsg.textContent = `更新成功: ${data.item.code}`;
            loadMyClipboards();
          } else {
            const data = await apiFetchJson('/api/create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', ...authHeaders() },
              body: JSON.stringify({ content, format })
            });

            codeBox.textContent = data.code;
            codeWrap.style.display = 'block';
            publishMsg.textContent = accessToken ? '发布成功（已归属到当前账号）' : '发布成功（未登录，未归属账号）';
          }

          if (accessToken) {
            loadMyClipboards();
          }
        } catch (err) {
          publishMsg.textContent = err.message;
        }
      });

      openBtn.addEventListener('click', async () => {
        const code = document.getElementById('codeInput').value.trim();
        if (!code) {
          openMsg.textContent = '请先输入编码';
          return;
        }

        openMsg.textContent = '加载中...';
        meta.textContent = '';
        render.innerHTML = '';

        try {
          const data = await apiFetchJson(`/api/get?code=${encodeURIComponent(code)}`);

          renderContent(data.content, data.format);
          meta.textContent = `格式: ${data.format} | 创建时间: ${new Date(data.created_at).toLocaleString()}`;
          openMsg.textContent = '';
        } catch (err) {
          openMsg.textContent = err.message;
        }
      });

      initAuth();
      setCreateMode();
      refreshEditorPreview();

      const initCode = new URLSearchParams(window.location.search).get('code');
      if (initCode) {
        document.getElementById('codeInput').value = initCode;
        openBtn.click();
      }
    </script>
  </body>
</html>
